<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Flurimo ‚Äî –ú–∞–≥–∞–∑–∏–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #faf9f7; }
header { padding: 16px; text-align: center; font-size: 22px; font-weight: 600; position: relative; }
.cart-button { position: absolute; right: 16px; top: 12px; font-size: 20px; cursor: pointer; }
.card { background: #fff; margin: 12px; border-radius: 14px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
.card img { width: 100%; height: 240px; object-fit: cover; }
.card-content { padding: 14px; }
.price { font-weight: bold; margin: 8px 0; }
.status { font-size: 13px; opacity: .6; margin-bottom: 10px; }
button { width: 100%; padding: 12px; background: #000; color: #fff; border: none; border-radius: 8px; font-size: 16px; }
button:disabled { background: #ccc; }
#cart { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.7); overflow-y: auto; padding-top: 60px; }
#cart-content { background: #fff; margin: auto; padding: 20px; border-radius: 14px; max-width: 500px; }
.cart-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
.cart-item span { margin: 0 5px; }
</style>
</head>
<body>
<header>
  üå∏ Flurimo
  <span class="cart-button" onclick="toggleCart()">üõí <span id="cart-count">0</span></span>
</header>

<div id="catalog"></div>

<div id="cart">
  <div id="cart-content">
    <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
    <div id="cart-items"></div>
    <div style="margin-top: 10px; font-weight:bold;">–ò—Ç–æ–≥–æ: <span id="cart-total">0</span> ‚ÇΩ</div>
    <button onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button style="margin-top: 10px; background:#ccc;color:#000;" onclick="toggleCart()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbwvGHiCa2eCV91H8eL-hFyKfffv2z-mv5HEnoPtDr7B3FuX23kj_hJMwUSQMydZZZUc5Q/exec";
let cart = [];

function toggleCart() {
  const cartDiv = document.getElementById("cart");
  cartDiv.style.display = cartDiv.style.display === "block" ? "none" : "block";
  renderCart();
}

function addToCart(item) {
  const existing = cart.find(i => i.name === item.name);
  if (existing) existing.quantity += 1;
  else cart.push({...item, quantity:1});
  updateCartCount();
}

function removeFromCart(name) {
  cart = cart.filter(i => i.name !== name);
  updateCartCount();
  renderCart();
}

function changeQuantity(name, delta) {
  const item = cart.find(i => i.name === name);
  if (!item) return;
  item.quantity += delta;
  if (item.quantity <= 0) removeFromCart(name);
  renderCart();
  updateCartCount();
}

function updateCartCount() {
  const count = cart.reduce((sum,i)=>sum+i.quantity,0);
  document.getElementById("cart-count").innerText = count;
}

function renderCart() {
  const container = document.getElementById("cart-items");
  container.innerHTML = "";
  let total = 0;
  cart.forEach(i => {
    total += i.price * i.quantity;
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      ${i.name} x${i.quantity} - ${i.price*i.quantity} ‚ÇΩ
      <span>
        <button onclick="changeQuantity('${i.name}',-1)">-</button>
        <button onclick="changeQuantity('${i.name}',1)">+</button>
        <button onclick="removeFromCart('${i.name}')">‚ùå</button>
      </span>
    `;
    container.appendChild(div);
  });
  document.getElementById("cart-total").innerText = total;
}

function checkout() {
  if(cart.length===0){ alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"); return; }
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è");
  const phone = prompt("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω");
  if(!name || !phone){ alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω"); return; }

  cart.forEach(item => {
    fetch(GOOGLE_SHEET_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        name:item.name,
        price:item.price,
        quantity:item.quantity,
        customer_name:name,
        customer_phone:phone
      })
    });
  });

  alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
  cart = [];
  updateCartCount();
  toggleCart();
}

const API_URL = "https://api.sheetbest.com/sheets/83be7af9-c3e1-4c11-b369-3e52a24f0cc5";
fetch(API_URL)
  .then(res=>res.json())
  .then(data=>{
    const catalog = document.getElementById("catalog");
    data.forEach(item=>{
      const name = item["Name"]?.trim() || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
      const image = item["Image"]?.trim();
      const description = item["Description"]?.trim() || "";
      const quantity = Number(item["Quantity"] || 0);
      const price = Number(item["Price"] || 0);

      let statusText="–ü–æ–¥ –∑–∞–∫–∞–∑", disabled=false;
      if(quantity>0){ statusText="–í –Ω–∞–ª–∏—á–∏–∏"; disabled=false; }

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <img src="${image}" alt="${name}" onerror="this.style.display='none'">
        <div class="card-content">
          <h3>${name}</h3>
          <p>${description}</p>
          <div class="status">${statusText}</div>
          <div class="price">${price} ‚ÇΩ</div>
          <button ${disabled?"":"onclick='addToCart({name:\"${name}\",price:${price}})'"}>–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
      `;
      catalog.appendChild(card);
    });
  })
  .catch(console.error);
</script>
</body>
</html>
